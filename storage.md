# 数据库大作业——储存模块——文档

刘译键 2016013239

苏宇荣 2015080045



## 概述

**项目仓库地址：** <https://github.com/liuyijian/naiveDB>

备注：处于保护代码角度考虑仓库被设置为私有，要查看源码可以请求加合作者，联系微信``lyj-newy``



## 模块结构

储存模块代码在`storage`包中

* ​	`BPlusTree.java`：在B+树节点类上封装的B+树类，相比B+树节点类增加范围删除功能，接口更加优雅
* ​	`ByteConverter.java`：Java常见数值类类型与byte[]的相互转换工具
* ​	`Entry.java`：键值对类
* ​	`Node.java`：B+树节点类，支持插入、删除、范围查询
* ​	`PrimaryKey.java`：主键类，支持多列主键，定义其比较规则，用于建立数据库索引
* ​	`ResultSet.java`：数据库查询返回的键值对数组类型
* ​	`Row.java`：用于表示数据库中的行，可通过属性或列号获取对应的属性值，包含基础的文件读写功能
* ​	`Storage.java`：主类，以PrimaryKey作为键，Row作为值，对BPlusTree作封装。内含有自定义文件格式管理功能
* ​	`Test.java`：储存模块测试用例
* ​	`Type.java`：定义类型与偏移量等常量



## 特性一览

* 支持记录的持久化。

* 支持对记录的增删改查。

* 高效的文件格式。

* 支持五种数据类型：``Int``，``Long``，``Float``，``Double``，``String``



### B+树

自写**标准的**B+树实现，支持**高效的范围查询**功能。顶层提供**高效的范围更新、范围删除功能**。



### 文件格式与读写策略

自定义的文件格式。文件可储存任意行数的数据，每一行均为固定长度的二进制数据。读取时的偏移和类型信息由元数据模块记录。

```
|  可用标记   |            n列数据             | n位图 null标记 | 
+------------+-------+-------+-------+-------+--------------+
| isAvailable| attr1 | attr2 | ..... | attrn |    isNull    |  
+------------+-------+-------+-------+-------+--------------+
```



**初始化**

逐行读取，如果该行`isAvailable`标记为`false`，意味该行存储的为有效数据，则读取该行主键信息进入内存，同时根据偏移等信息建立B+树索引。



**读访问**

`Row.java`维护了`isInMemory`，记录行数据是否被缓存。如果读访问该行时发现数据未被缓存，则从文件中加载行数据进入内存，必要时引发缓存替换机制。



**写访问**

`Row.java`维护了`isModified`，记录行数据是否被更改存。如果写访问该行时发现数据未被缓存，则从文件中加载行数据进入内存，再进行更改操作。写操作后`isModified`标记会被记录为`true`。

该行数据若因为替换机制被踢出内存时（或者关闭数据库时），会根据`isModified`决定是否进行写操作。



### 缓存策略

维护一个缓存池，当缓存的行数据超过限定值时，引发替换写回机制。
